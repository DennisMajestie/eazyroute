<div class="route-display-container">
    <!-- Header -->
    <div class="route-header">
        <button class="btn-back" (click)='goBack()' type="button" title="Go Back">
            <i class="fas fa-arrow-left"></i>
        </button>
        <div class="route-title" *ngIf="route">
            <div class="route-from-to">
                <span class="from-label">{{ route.from }}</span>
                <span class="arrow-icon"><i class="fas fa-long-arrow-alt-right"></i></span>
                <span class="to-label">{{ route.to }}</span>
            </div>
            <div class="route-meta-line">
                <span class="legs-badge"><i class="fas fa-route"></i> {{ route.segments.length }} legs, {{
                    (route.totalDistance / 1000).toFixed(1) }}km</span>
            </div>
        </div>
        <div class="street-mode-toggle" (click)="useStreetMode = !useStreetMode" [class.active]="useStreetMode"
            title="Toggle Street Mode (Pidgin Directions)">
            <span class="toggle-icon">üó£Ô∏è</span>
            <span class="toggle-label">{{ useStreetMode ? 'Street' : 'Normal' }}</span>
        </div>
    </div>

    <!-- Night Mode Active Banner -->
    <div class="night-mode-banner" *ngIf="isNightMode">
        <div class="banner-header">
            <span class="icon">üåô</span>
            <span>Night Mode Active</span>
        </div>
        <div class="safety-tips-list">
            <div class="tip" *ngFor="let tip of nightTips">
                <span class="tip-icon">{{ tip.icon }}</span>
                <span class="tip-text">{{ tip.text }}</span>
            </div>
        </div>
    </div>

    <!-- Route Rationale & Warnings -->
    <div class="route-rationale" *ngIf="route?.rationale || route?.metadata?.ribExitApplied">
        <div class="rationale-text" *ngIf="route?.rationale">
            üí° {{ route?.rationale }}
        </div>
        <div class="warning-tag" *ngIf="route?.metadata?.ribExitApplied">
            üöß Village Exit Fee Included
        </div>
    </div>

    <!-- Route Summary Bar -->
    <div class="route-summary" *ngIf="route">
        <div class="summary-item">
            <span class="summary-icon">‚è±Ô∏è</span>
            <span class="summary-value">{{ route.totalTime }} min</span>
        </div>
        <div class="summary-divider"></div>
        <div class="summary-item">
            <span class="summary-icon">üí∞</span>
            <span class="summary-value">{{ getCostDisplay() }}</span>
        </div>
        <div class="summary-divider"></div>
        <div class="summary-item">
            <span class="summary-icon">üìè</span>
            <span class="summary-value">{{ (route.totalDistance / 1000).toFixed(1) }}km</span>
        </div>
    </div>


    <!-- Loading State -->
    <div class="loading-state" *ngIf="isLoading">
        <div class="spinner-large"></div>
        <p>Generating your route...</p>
    </div>

    <!-- Error State -->
    <div class="error-state" *ngIf="error && !isLoading">
        <div class="error-icon">‚ö†Ô∏è</div>
        <p class="error-message">{{ error }}</p>
        <button class="btn btn-primary" (click)="generateRoute()">
            Try Again
        </button>
    </div>

    <!-- Route Content -->
    <div class="route-content" *ngIf="!isLoading && !error && route">

        <!-- Friday Surge Warning -->
        <div class="surge-warning" *ngIf="route.metadata?.isSurgeApplied">
            <span class="warning-icon">‚ö†Ô∏è</span>
            <div class="warning-text">
                <strong>Heavy Traffic (Friday Prayer)</strong>
                <p>ETA may be longer than usual due to congregational prayers.</p>
            </div>
        </div>

        <!-- Interactive Map -->
        <div class="map-section">
            <app-map [center]="mapCenter" [zoom]="13" [markers]="mapMarkers" [polylines]="mapPolylines">
            </app-map>
            <div class="map-overlay-badge" *ngIf="route?.metadata?.backbonePriority">
                <i class="fas fa-road"></i> Expressway Backbone
            </div>
        </div>

        <!-- üåü Hybrid Intelligence: Recommended Route Card -->
        <div class="recommended-card" *ngIf="recommendedRoute" [class.selected]="selectedRouteIndex === 0"
            (click)="selectRoute(0)">
            <div class="card-header">
                <span class="badge-recommended">üåü Recommended</span>
                <span class="badge-strategy" *ngIf="getStrategyBadge(recommendedRoute)">
                    {{ getStrategyBadge(recommendedRoute) }}
                </span>

                <!-- Dynamic Intelligence Badge -->
                <div class="dynamic-badge" *ngIf="getDynamicBadge(recommendedRoute.dynamicAdjustment) as badge"
                    [class]="badge.type">
                    <span class="badge-icon">
                        <i class="fas" [ngClass]="{
                            'fa-bolt': badge.type === 'fare',
                            'fa-clock': badge.type === 'wait',
                            'fa-exclamation-triangle': badge.type === 'risk',
                            'fa-traffic-light': badge.type === 'traffic'
                        }"></i>
                    </span>
                    {{ badge.label }}
                </div>
            </div>

            <div class="card-body">
                <div class="route-main-info">
                    <div class="info-time">
                        <span class="value">{{ recommendedRoute.totalTime }}</span>
                        <span class="unit">min</span>
                    </div>
                    <div class="info-cost">
                        <span class="currency">‚Ç¶</span>
                        <span class="value">{{ formatCost(recommendedRoute.totalCost) }}</span>
                    </div>
                </div>

                <div class="route-meta-info">
                    <span>{{ (recommendedRoute.totalDistance / 1000).toFixed(1) }}km</span>
                    <span class="separator">‚Ä¢</span>
                    <span>{{ recommendedRoute.segments.length }} legs</span>
                </div>
            </div>

            <div class="card-rationale" *ngIf="recommendedRoute.rationale">
                üí° {{ recommendedRoute.rationale }}
            </div>
        </div>

        <!-- üîÑ Alternatives Toggle -->
        <div class="alternatives-section" *ngIf="alternativeRoutes.length > 0">
            <h3 class="section-title">Alternative Options</h3>

            <div class="alternatives-list">
                <div class="alternative-card" *ngFor="let r of alternativeRoutes; let i = index"
                    [class.selected]="selectedRouteIndex === (i + 1)" (click)="selectRoute(i + 1)">

                    <div class="alt-header">
                        <span class="alt-strategy">{{ r.classification || 'Alternative' }}</span>
                        <!-- Dynamic Badge for Alt -->
                        <div class="dynamic-badge mini" *ngIf="getDynamicBadge(r.dynamicAdjustment) as badge"
                            [class]="badge.type">
                            {{ badge.label }}
                        </div>
                    </div>

                    <div class="alt-body">
                        <div class="alt-time">{{ r.totalTime }} min</div>
                        <div class="alt-cost">‚Ç¶{{ formatCost(r.totalCost) }}</div>
                    </div>

                    <div class="alt-diff" *ngIf="getRouteDiff(r)">
                        {{ getRouteDiff(r) }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Journey Steps (Vertical Timeline) -->
        <div class="journey-section">
            <h2 class="section-title">üõ£Ô∏è Suggested Route</h2>

            <div class="timeline-container">
                <!-- Start Point -->
                <div class="timeline-point start">
                    <div class="point-marker"></div>
                    <div class="point-content">
                        <h3>{{ route.from }}</h3>
                        <span class="time-label">Start</span>
                    </div>
                </div>

                <!-- Segments -->
                <div class="timeline-segment" *ngFor="let segment of route.segments; let i = index; let last = last">

                    <!-- Connector Line -->
                    <div class="segment-connector" [style.background-color]="getSegmentColor(segment)"
                        [class.backbone-line]="segment.backbonePriority"></div>

                    <!-- Backbone Priority Indicator -->
                    <div class="backbone-badge" *ngIf="segment.backbonePriority">
                        Standard Artery Fare
                    </div>

                    <!-- Mode Card -->
                    <div class="mode-card" [class.expanded]="isSegmentExpanded(i)" (click)="toggleSegment(i)"
                        [class.backbone-card]="segment.backbonePriority"
                        [style.border-left-color]="getSegmentColor(segment)">

                        <div class="mode-header">
                            <div class="mode-icon" [style.background-color]="getSegmentColor(segment)">
                                {{ getSegmentEmoji(segment) }}
                            </div>
                            <div class="mode-info">
                                <div class="mode-title">
                                    <span class="mode-name">{{ getSegmentMode(segment) | uppercase }}</span>
                                    <span class="mode-cost" *ngIf="segment.cost">‚Ç¶{{ formatCost(segment.cost) }}</span>
                                </div>
                                <div class="mode-meta">
                                    <span *ngIf="segment.distance">{{ segment.distance }}m</span>
                                    <span *ngIf="segment.estimatedTime">‚Ä¢ {{ segment.estimatedTime }} min</span>
                                    <span class="bridge-tag" *ngIf="segment.bridgeEnabled">üåâ Bridge</span>
                                </div>

                                <!-- Dynamic Adjustment Indicator for Segment -->
                                <div class="segment-dynamic-hint" *ngIf="segment.dynamicAdjustment">
                                    <i class="fas fa-bolt"></i>
                                </div>
                            </div>
                            <div class="mode-expand">
                                {{ isSegmentExpanded(i) ? '‚ñ≤' : '‚ñº' }}
                            </div>
                        </div>

                        <!-- Expanded Details -->
                        <div class="mode-details" *ngIf="isSegmentExpanded(i)">
                            <!-- Dynamic Adjustment Rationale -->
                            <div class="dynamic-rationale" *ngIf="segment.dynamicAdjustment?.rationale">
                                <span class="icon">üîç</span>
                                <p>{{ segment.dynamicAdjustment?.rationale }}</p>
                            </div>

                            <!-- Guidance Bubble -->
                            <div class="guidance-bubble">
                                <span class="guidance-icon">üì¢</span>
                                <p class="instruction">{{ segment.instructions || segment.instruction }}</p>
                            </div>

                            <!-- Security Status -->
                            <div class="security-card" *ngIf="getSecurityInfo(segment) as security">
                                <div class="security-header">
                                    <span class="security-label">üõ°Ô∏è Commuter Guardian</span>
                                    <span class="risk-badge" [class]="security.risk.toLowerCase()">
                                        {{ getRiskLabel(security.risk) }}
                                    </span>
                                </div>
                                <div class="safety-advice" *ngIf="security.advice">
                                    {{ security.advice }}
                                </div>
                                <div class="threat-tags" *ngIf="security.threats.length > 0">
                                    <span class="threat-tag" *ngFor="let threat of security.threats">‚ö†Ô∏è {{ threat
                                        }}</span>
                                </div>
                            </div>

                            <!-- Boarding Strength Hub Status -->
                            <div class="hub-status-card" *ngIf="getBoardingStrengthInfo(segment) as hub">
                                <div class="hub-header" *ngIf="hub.isMajorHub">
                                    <span class="hub-badge strong">‚úÖ Major {{ getSegmentMode(segment) | titlecase }}
                                        Hub</span>
                                    <span class="hub-hint">Plenty {{ getSegmentMode(segment) }} here</span>
                                </div>
                                <div class="hub-header" *ngIf="hub.isWeak">
                                    <span class="hub-badge weak">üö´ {{ getSegmentMode(segment) | titlecase }}s rare
                                        here</span>
                                    <span class="hub-hint">Better to board at <strong>{{ hub.backboneName
                                            }}</strong></span>
                                </div>
                            </div>

                            <!-- Boarding Protocol (Shouting) -->
                            <div class="protocol-card" *ngIf="getHubProtocol(segment) as protocol">
                                <div class="protocol-header">üó£Ô∏è Conductor Shout</div>
                                <div class="shout-box">"{{ protocol.shout }}"</div>
                                <div class="protocol-meta">
                                    <span class="location">üìç {{ protocol.location }}</span>
                                    <span class="price">üí∞ ‚Ç¶{{ protocol.price.min }} - {{ protocol.price.max }}</span>
                                </div>
                                <div class="protocol-tip">üí° {{ protocol.tip }}</div>
                            </div>

                            <!-- Intermediate Stops Dropdown -->
                            <div class="intermediate-stops"
                                *ngIf="segment.intermediateStops && segment.intermediateStops.length > 0">
                                <button class="stops-toggle" (click)="$event.stopPropagation(); toggleStops(i)">
                                    {{ showStops[i] ? 'Hide' : 'View' }} {{ segment.intermediateStops.length }} stops
                                </button>
                                <ul class="stops-list" *ngIf="showStops[i]">
                                    <li *ngFor="let stop of segment.intermediateStops">
                                        <span class="stop-dot"></span>
                                        {{ stop.name }}
                                    </li>
                                </ul>
                            </div>

                            <!-- Reporting Actions -->
                            <div class="reporting-section">
                                <button class="btn-report" (click)="$event.stopPropagation(); openReporting(segment)">
                                    <i class="fas fa-bullhorn"></i> Report Live Condition
                                </button>
                                <button class="btn-price" *ngIf="segment.type !== 'walk' && segment.type !== 'wait'"
                                    (click)="$event.stopPropagation(); openSubmitPrice(segment)">
                                    ‚ûï Contribute Fare Info
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Transfer Node (between segments) -->
                    <div class="timeline-point transfer" *ngIf="!last">
                        <div class="point-marker small"></div>
                        <div class="point-label" *ngIf="segment.toStop">
                            {{ getStopName(segment.toStop) }}
                        </div>
                    </div>
                </div>

                <!-- End Point -->
                <div class="timeline-point end">
                    <div class="point-marker"></div>
                    <div class="point-content">
                        <h3>{{ route.to }}</h3>
                        <span class="time-label">Destination</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-primary btn-xl" (click)="startJourney()" [disabled]="isStartingJourney">
                <span *ngIf="isStartingJourney" class="spinner-border spinner-border-sm me-2"></span>
                {{ isStartingJourney ? 'Starting...' : 'üöÄ Start Journey' }}
            </button>
            <button class="btn btn-secondary btn-lg" (click)="shareRoute()">
                üì§ Share via WhatsApp
            </button>
        </div>

        <!-- Quick Instructions -->
        <div class="quick-instructions">
            <h3 class="instructions-title">üìù Quick Summary</h3>

            <ol class="instructions-list">
                <li *ngFor="let instruction of route.instructions">
                    <span class="instruction-icon">{{ getDirectionIcon(instruction) }}</span>
                    <span class="instruction-text">{{ instruction }}</span>
                </li>
            </ol>
        </div>
    </div>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="!isLoading && !error && !route">
        <div class="empty-icon">üó∫Ô∏è</div>
        <h3>No route data</h3>
        <p>Please start from the home screen</p>
        <button class="btn btn-primary" (click)="goBack()">
            Go to Home
        </button>
    </div>

    <!-- Street Intelligence FAB (Global on route screen) -->
    <button class="street-intel-fab" (click)="openReporting(route!.segments[0])" *ngIf="route">
        <div class="fab-icon"><i class="fas fa-bullhorn"></i></div>
        <div class="fab-text">Street Intelligence</div>
    </button>

    <!-- Intelligence Reporting Bottom Sheet -->
    <div class="bottom-sheet-overlay" *ngIf="showReportingModal" (click)="closeReporting()">
        <div class="bottom-sheet" (click)="$event.stopPropagation()">
            <div class="sheet-handle"></div>
            <div class="sheet-header">
                <h3>Live Street Intelligence</h3>
                <p>What's happening on the road right now?</p>
            </div>

            <div class="report-types">
                <div class="report-type-item" (click)="reportType = 'fare'" [class.active]="reportType === 'fare'">
                    <div class="type-icon fare"><i class="fas fa-money-bill-wave"></i></div>
                    <span>Fare</span>
                </div>
                <div class="report-type-item" (click)="reportType = 'wait_time'"
                    [class.active]="reportType === 'wait_time'">
                    <div class="type-icon wait"><i class="fas fa-hourglass-half"></i></div>
                    <span>Wait</span>
                </div>
                <div class="report-type-item" (click)="reportType = 'risk_alert'"
                    [class.active]="reportType === 'risk_alert'">
                    <div class="type-icon risk"><i class="fas fa-shield-alt"></i></div>
                    <span>Risk</span>
                </div>
                <div class="report-type-item" (click)="reportType = 'stop_alias'"
                    [class.active]="reportType === 'stop_alias'">
                    <div class="type-icon alias"><i class="fas fa-tag"></i></div>
                    <span>Alias</span>
                </div>
            </div>

            <div class="report-inputs">
                <div class="input-group" *ngIf="reportType === 'fare'">
                    <label>Current Fare (‚Ç¶)</label>
                    <input type="number" [(ngModel)]="reportValue.fare" placeholder="e.g. 300">
                </div>
                <div class="input-group" *ngIf="reportType === 'wait_time'">
                    <label>Wait Duration</label>
                    <select [(ngModel)]="reportValue.waitTime">
                        <option value="short">Short (< 5 mins)</option>
                        <option value="medium">Medium (5-15 mins)</option>
                        <option value="long">Long (> 15 mins)</option>
                    </select>
                </div>
                <div class="input-group" *ngIf="reportType === 'risk_alert'">
                    <label>Security Detail</label>
                    <textarea [(ngModel)]="reportValue.riskAlert"
                        placeholder="Describe the safety concern..."></textarea>
                </div>
                <div class="input-group" *ngIf="reportType === 'stop_alias'">
                    <label>Common Name</label>
                    <input type="text" [(ngModel)]="reportValue.stopAlias" placeholder="What do locals call this stop?">
                </div>
            </div>

            <div class="sheet-actions">
                <button class="btn btn-secondary" (click)="closeReporting()">Cancel</button>
                <button class="btn btn-primary" (click)="submitCommunityReport()" [disabled]="isSubmittingReport">
                    {{ isSubmittingReport ? 'Reporting...' : 'Submit Intelligence' }}
                </button>
            </div>
        </div>
    </div>

    <!-- Submit Price Modal (Legacy Context) -->
    <app-submit-price *ngIf="showSubmitPriceModal" [fromStopName]="submitData.from" [toStopName]="submitData.to"
        [transportMode]="submitData.mode" [fromStopId]="submitData.fromId" [toStopId]="submitData.toId"
        [distance]="submitData.distance" [estimatedTime]="submitData.estimatedTime"
        (close)="showSubmitPriceModal = false" (submitted)="onPriceSubmitted()">
    </app-submit-price>
</div>