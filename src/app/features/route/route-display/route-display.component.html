<div class="route-display-container">
    <!-- Header -->
    <div class="route-header">
        <button class="back-btn" (click)="goBack()" type="button">
            ‚Üê Back
        </button>
        <div class="route-title">
            <h1 class="from-to">{{ route?.from }} ‚Üí {{ route?.to }}</h1>
        </div>
    </div>

    <!-- Night Mode Active Banner -->
    <div class="night-mode-banner" *ngIf="isNightMode">
        <div class="banner-header">
            <span class="icon">üåô</span>
            <span>Night Mode Active</span>
        </div>
        <div class="safety-tips-list">
            <div class="tip" *ngFor="let tip of nightTips">
                <span class="tip-icon">{{ tip.icon }}</span>
                <span class="tip-text">{{ tip.text }}</span>
            </div>
        </div>
    </div>

    <!-- Route Selection Tabs -->
    <div class="route-tabs" *ngIf="routes && routes.length > 0">
        <div class="route-tab" *ngFor="let r of routes; let i = index" [class.active]="i === selectedRouteIndex"
            (click)="selectRoute(i)">

            <div class="tab-badge" [class.fastest]="r.classification === 'FASTEST'"
                [class.cheapest]="r.classification === 'CHEAPEST'">
                {{ r.classification || getStrategyLabel(r.metadata?.strategy || 'balanced') }}
            </div>
            <div class="tab-info">
                <span class="tab-time">{{ r.totalTime }} min</span>
                <span class="tab-cost">‚Ç¶{{ r.totalCost }}</span>
            </div>
            <div class="tab-diff" *ngIf="getRouteDiff(r)">
                {{ getRouteDiff(r) }}
            </div>
        </div>
    </div>

    <!-- Route Rationale & Warnings -->
    <div class="route-rationale" *ngIf="route?.rationale || route?.metadata?.ribExitApplied">
        <div class="rationale-text" *ngIf="route?.rationale">
            üí° {{ route?.rationale }}
        </div>
        <div class="warning-tag" *ngIf="route?.metadata?.ribExitApplied">
            üöß Village Exit Fee Included
        </div>
    </div>

    <!-- Route Summary Bar -->
    <div class="route-summary" *ngIf="route">
        <div class="summary-item">
            <span class="summary-icon">‚è±Ô∏è</span>
            <span class="summary-value">{{ route.totalTime }} min</span>
        </div>
        <div class="summary-divider"></div>
        <div class="summary-item">
            <span class="summary-icon">üí∞</span>
            <span class="summary-value">{{ getCostDisplay() }}</span>
        </div>
        <div class="summary-divider"></div>
        <div class="summary-item">
            <span class="summary-icon">üìè</span>
            <span class="summary-value">{{ (route.totalDistance / 1000).toFixed(1) }}km</span>
        </div>
    </div>


    <!-- Loading State -->
    <div class="loading-state" *ngIf="isLoading">
        <div class="spinner-large"></div>
        <p>Generating your route...</p>
    </div>

    <!-- Error State -->
    <div class="error-state" *ngIf="error && !isLoading">
        <div class="error-icon">‚ö†Ô∏è</div>
        <p class="error-message">{{ error }}</p>
        <button class="btn btn-primary" (click)="generateRoute()">
            Try Again
        </button>
    </div>

    <!-- Route Content -->
    <div class="route-content" *ngIf="!isLoading && !error && route">

        <!-- Friday Surge Warning -->
        <div class="surge-warning" *ngIf="route.metadata?.isSurgeApplied">
            <span class="warning-icon">‚ö†Ô∏è</span>
            <div class="warning-text">
                <strong>Heavy Traffic (Friday Prayer)</strong>
                <p>ETA may be longer than usual due to congregational prayers.</p>
            </div>
        </div>

        <!-- Map Section -->
        <div class="map-section">
            <div class="map-wrapper" *ngIf="!isLoading && route"
                style="height: 350px; border-radius: 12px; overflow: hidden; margin-bottom: 20px; border: 1px solid var(--border-color);">
                <app-map [center]="mapCenter" [zoom]="mapZoom" [markers]="mapMarkers"
                    [polylines]="mapPolylines"></app-map>
            </div>

            <div class="map-hint-container" *ngIf="route?.metadata?.backbonePriority">
                <span class="backbone-hint">‚ú® Optimized via Expressway Backbone</span>
            </div>
        </div>

        <!-- Journey Steps (Vertical Timeline) -->
        <div class="journey-section">
            <h2 class="section-title">üõ£Ô∏è Suggested Route</h2>

            <div class="timeline-container">
                <!-- Start Point -->
                <div class="timeline-point start">
                    <div class="point-marker"></div>
                    <div class="point-content">
                        <h3>{{ route.from }}</h3>
                        <span class="time-label">Start</span>
                    </div>
                </div>

                <!-- Segments -->
                <div class="timeline-segment" *ngFor="let segment of route.segments; let i = index; let last = last">

                    <!-- Connector Line -->
                    <div class="segment-connector" [style.background-color]="getSegmentColor(segment)"
                        [class.backbone-line]="segment.backbonePriority"></div>

                    <!-- Backbone Priority Indicator -->
                    <div class="backbone-badge" *ngIf="segment.backbonePriority">
                        Standard Artery Fare
                    </div>

                    <!-- Mode Card -->
                    <div class="mode-card" [class.expanded]="isSegmentExpanded(i)" (click)="toggleSegment(i)"
                        [class.backbone-card]="segment.backbonePriority"
                        [style.border-left-color]="getSegmentColor(segment)">

                        <div class="mode-header">
                            <div class="mode-icon" [style.background-color]="getSegmentColor(segment)">
                                {{ getSegmentEmoji(segment) }}
                            </div>
                            <div class="mode-info">
                                <div class="mode-title">
                                    <span class="mode-name">{{ (segment.vehicleType || segment.type) | uppercase
                                        }}</span>
                                    <span class="mode-cost" *ngIf="segment.cost">‚Ç¶{{ formatCost(segment.cost) }}</span>
                                </div>
                                <div class="mode-meta">
                                    <span *ngIf="segment.distance">{{ segment.distance }}m</span>
                                    <span *ngIf="segment.estimatedTime">‚Ä¢ {{ segment.estimatedTime }} min</span>
                                    <span class="bridge-tag" *ngIf="segment.bridgeEnabled">üåâ Bridge</span>
                                </div>
                            </div>
                            <div class="mode-expand">
                                {{ isSegmentExpanded(i) ? '‚ñ≤' : '‚ñº' }}
                            </div>
                        </div>

                        <!-- Expanded Details -->
                        <div class="mode-details" *ngIf="isSegmentExpanded(i)">
                            <!-- Guidance Bubble -->
                            <div class="guidance-bubble">
                                <span class="guidance-icon">üì¢</span>
                                <p class="instruction">{{ segment.instructions || segment.instruction }}</p>
                            </div>

                            <!-- Boarding Protocol (Shouting) -->
                            <div class="protocol-card" *ngIf="getHubProtocol(segment) as protocol">
                                <div class="protocol-header">üó£Ô∏è Conductor Shout</div>
                                <div class="shout-box">"{{ protocol.shout }}"</div>
                                <div class="protocol-meta">
                                    <span class="location">üìç {{ protocol.location }}</span>
                                    <span class="price">üí∞ ‚Ç¶{{ protocol.price.min }} - {{ protocol.price.max }}</span>
                                </div>
                                <div class="protocol-tip">üí° {{ protocol.tip }}</div>
                            </div>

                            <!-- Pedestrian Bridge Alert -->
                            <div class="bridge-alert" *ngIf="segment.bridgeEnabled">
                                <span class="alert-icon">üåâ</span>
                                <div class="alert-content">
                                    <strong>Use Pedestrian Bridge</strong>
                                    <p>Safety alert: Do not cross the expressway on foot.</p>
                                </div>
                            </div>

                            <!-- Intermediate Stops Dropdown -->
                            <div class="intermediate-stops"
                                *ngIf="segment.intermediateStops && segment.intermediateStops.length > 0">
                                <button class="stops-toggle" (click)="$event.stopPropagation(); toggleStops(i)">
                                    {{ showStops[i] ? 'Hide' : 'View' }} {{ segment.intermediateStops.length }} stops
                                </button>
                                <ul class="stops-list" *ngIf="showStops[i]">
                                    <li *ngFor="let stop of segment.intermediateStops">
                                        <span class="stop-dot"></span>
                                        {{ stop.name }}
                                    </li>
                                </ul>
                            </div>

                            <!-- Micro-Instruction (Drop off) -->
                            <div class="micro-instruction" *ngIf="segment.dropInstruction">
                                <span class="micro-icon">üí°</span>
                                <span>{{ segment.dropInstruction }}</span>
                            </div>

                            <!-- Micro-Instruction (Wait/Transfer) -->
                            <div class="micro-instruction warning"
                                *ngIf="segment.type === 'wait' || segment.type === 'transfer'">
                                <span class="micro-icon">‚ö†Ô∏è</span>
                                <span>Check for oncoming traffic</span>
                            </div>

                            <!-- Contribute Price Button -->
                            <div class="contribute-section" *ngIf="segment.type !== 'walk' && segment.type !== 'wait'">
                                <button class="btn-link-sm"
                                    (click)="$event.stopPropagation(); openSubmitPrice(segment)">
                                    ‚ûï Contribute Price Info
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Transfer Node (between segments) -->
                    <div class="timeline-point transfer" *ngIf="!last">
                        <div class="point-marker small"></div>
                        <div class="point-label" *ngIf="segment.toStop">
                            {{ segment.toStop }}
                        </div>
                    </div>
                </div>

                <!-- End Point -->
                <div class="timeline-point end">
                    <div class="point-marker"></div>
                    <div class="point-content">
                        <h3>{{ route.to }}</h3>
                        <span class="time-label">Destination</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-primary btn-xl" (click)="startJourney()">
                üöÄ Start Journey
            </button>
            <button class="btn btn-secondary btn-lg" (click)="shareRoute()">
                üì§ Share via WhatsApp
            </button>
        </div>

        <!-- Quick Instructions -->
        <div class="quick-instructions">
            <h3 class="instructions-title">üìù Quick Summary</h3>

            <ol class="instructions-list">
                <li *ngFor="let instruction of route.instructions">
                    <span class="instruction-icon">{{ getDirectionIcon(instruction) }}</span>
                    <span class="instruction-text">{{ instruction }}</span>
                </li>
            </ol>
        </div>
    </div>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="!isLoading && !error && !route">
        <div class="empty-icon">üó∫Ô∏è</div>
        <h3>No route data</h3>
        <p>Please start from the home screen</p>
        <button class="btn btn-primary" (click)="goBack()">
            Go to Home
        </button>
    </div>

    <!-- Submit Price Modal -->
    <app-submit-price *ngIf="showSubmitPriceModal" [fromStopName]="submitData.from" [toStopName]="submitData.to"
        [transportMode]="submitData.mode" [fromStopId]="submitData.fromId" [toStopId]="submitData.toId"
        (close)="showSubmitPriceModal = false" (submitted)="onPriceSubmitted()">
    </app-submit-price>
</div>