<div class="trip-tracking-container" *ngIf="orchestratorState$ | async as state">
    <!-- No Active Trip State -->
    <div *ngIf="!state.hasActiveTrip" class="no-trip-state">
        <div class="empty-state text-center p-5">
            <i class="fas fa-route fa-4x text-muted mb-3"></i>
            <h3>No Active Trip</h3>
            <p class="text-muted">Start a trip from the Trip Planner to begin tracking.</p>
            <a routerLink="/trip-planner" class="btn btn-primary">
                <i class="fas fa-map-marked-alt me-2"></i> Plan a Trip
            </a>
        </div>
    </div>

    <!-- Active Trip UI -->
    <div *ngIf="state.hasActiveTrip" class="active-trip-ui">
        <!-- Status Header -->
        <header class="status-header">
            <div class="live-badge">
                <span class="pulse-dot"></span>
                LIVE
            </div>
            <div class="status-info">
                <h2 class="status-text">{{ state.tripStatus | titlecase }}</h2>
                <span class="trip-id">Trip #{{ state.currentTripId?.slice(0, 8) }}</span>
            </div>
            <div class="eta-badge" *ngIf="etaMinutes > 0">
                <i class="fas fa-clock"></i>
                <span>{{ getFormattedETA() }}</span>
            </div>
        </header>

        <!-- Current Step Card -->
        <section class="current-step-card" *ngIf="currentStep">
            <div class="step-icon">
                <i [class]="currentStep.transportIcon"></i>
            </div>
            <div class="step-content">
                <div class="step-instruction">{{ currentStep.instruction }}</div>
                <div class="step-details">
                    <span class="from-to">
                        <i class="fas fa-map-pin text-success me-1"></i>
                        {{ currentStep.fromStop }}
                        <i class="fas fa-arrow-right mx-2"></i>
                        <i class="fas fa-flag-checkered text-danger me-1"></i>
                        {{ currentStep.toStop }}
                    </span>
                </div>
                <div class="step-meta">
                    <span *ngIf="currentStep.cost > 0" class="cost-badge">
                        <i class="fas fa-money-bill-wave"></i> ₦{{ currentStep.cost }}
                    </span>
                    <span class="time-badge">
                        <i class="fas fa-hourglass-half"></i> {{ currentStep.estimatedTime }} min
                    </span>
                </div>
            </div>
            <button class="done-btn" (click)="markSegmentComplete()" *ngIf="!currentStep.isLastSegment">
                <i class="fas fa-check"></i>
                Done
            </button>
        </section>

        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-bar-wrapper">
                <div class="progress-fill" [style.width.%]="progressPercent"></div>
            </div>
            <div class="progress-labels">
                <span>{{ progressPercent }}% complete</span>
                <span>{{ distanceRemainingKm.toFixed(1) }} km left</span>
            </div>
        </div>

        <!-- Timeline (Compact) -->
        <section class="timeline-section" *ngIf="currentRoute && currentRoute.segments">
            <h4 class="section-title">
                <i class="fas fa-list-ol me-2"></i> Journey Steps
            </h4>
            <div class="timeline-compact">
                <div *ngFor="let segment of currentRoute.segments; let i = index" class="timeline-item"
                    [class.completed]="getSegmentStatus(i) === 'completed'"
                    [class.current]="getSegmentStatus(i) === 'current'"
                    [class.upcoming]="getSegmentStatus(i) === 'upcoming'">
                    <div class="timeline-marker">
                        <i *ngIf="getSegmentStatus(i) === 'completed'" class="fas fa-check"></i>
                        <span *ngIf="getSegmentStatus(i) !== 'completed'">{{ i + 1 }}</span>
                    </div>
                    <div class="timeline-content">
                        <i [class]="getTransportIcon(segment.mode.type) + ' me-2'"></i>
                        <span class="segment-label">{{ segment.toStop.name || 'Stop ' + (i + 1) }}</span>
                        <span class="segment-cost" *ngIf="segment.cost > 0">₦{{ segment.cost }}</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Map Section -->
        <section class="map-section">
            <app-map [center]="center" [zoom]="zoom" [polylines]="routePolylines">
            </app-map>
        </section>

        <!-- Trip Summary Footer -->
        <footer class="trip-summary-footer">
            <div class="summary-stats">
                <div class="stat">
                    <i class="fas fa-clock"></i>
                    <span class="value">{{ etaMinutes }}</span>
                    <span class="label">min left</span>
                </div>
                <div class="stat">
                    <i class="fas fa-money-bill-wave"></i>
                    <span class="value">₦{{ totalCost }}</span>
                    <span class="label">total</span>
                </div>
                <div class="stat">
                    <i class="fas fa-route"></i>
                    <span class="value">{{ distanceRemainingKm.toFixed(1) }}</span>
                    <span class="label">km left</span>
                </div>
            </div>
        </footer>

        <!-- Control Buttons (Fixed at bottom) -->
        <div class="control-buttons">
            <button class="btn btn-outline-warning flex-grow-1" (click)="reportIssue()">
                <i class="fas fa-exclamation-triangle me-2"></i> Report Issue
            </button>
            <button class="btn btn-danger flex-grow-1" (click)="stopTrip()">
                <i class="fas fa-stop-circle me-2"></i> End Trip
            </button>
        </div>

        <!-- Custom Confirmation Modal -->
        <div class="modal-overlay" *ngIf="showEndTripModal">
            <div class="trip-confirm-modal">
                <div class="modal-icon">
                    <i class="fas fa-stop-circle"></i>
                </div>
                <h3>End This Trip?</h3>
                <p>Are you sure you want to end your journey now? This will stop all tracking and safety alerts.</p>
                <div class="modal-actions">
                    <button class="btn btn-danger" (click)="confirmEndTrip()">
                        Yes, End Trip
                    </button>
                    <button class="btn btn-outline-light" (click)="cancelEndTrip()">
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- SOS Emergency Button -->
        <app-sos-button></app-sos-button>
    </div>
</div>